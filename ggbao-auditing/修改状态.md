
1. 修改状态

Url

```
http://auditing1.guanggaobao.com.cn/api/client/auditor_material_status_change
```


测试用户

```
u=18019101111
p=18019101111
无任何审核权限的管理员

u=18019101112
p=18019101112
初级审核员

u=18019101114
p=18019101114
另一个初级审核员

u=18019101113
p=18019101113
高级审核员
```

USER STORY

无权限用户试图初审材料

```
{
  "login": "18019101111",
  "password": "18019101111",
  "material_id": 4028,
  "toStatus": "正在初审"
}
```

返回

```
{
  "errors": [
    "需要初审权限"
  ],
...
```

初审用户A登陆

```
{
  "login": "18019101112",
  "password": "18019101112",
  "material_id": 4028,
  "toStatus": "正在初审"
}
```

返回 ** 嘈:PHP代码里边我定义的是flag:1成功,0失败,跟java里是反的... **

```
{
  "errors": [],
  "debug": [],
  ...
  "flag":"1"
}
```

另一个初审用户B试图将其置为已初审

```
{
  "login": "18019101114",
  "password": "18019101114",
  "material_id": 4028,
  "toStatus": "已初审"
}
```

返回错误

```
{
  "errors": [
    "此材料正由其他人审核中"
  ],
  ...
  "flag":"0"
}
```

初审用户A将材料状态改为已初审(略)

终审员C将材料设为正在终审(返回略)

```
{
  "login": "18019101113",
  "password": "18019101113",
  "material_id": 4028,
  "toStatus": "正在终审"
}
```

此时初审用户A无法再提交审核信息

终审通过/不通过需要同一个终审员C 通过 [审核员---上传结果](ggbao-auditing/上传结果.md) API实现



Request

```
{
  "login": "18019101985",
  "password": "pass",
  "material_id":123,
  "toStatus":"xxx",
}
```

几种错误:

a. "错误的状态转换路径,材料当前状态为:xxx 目标状态为:xxx" 

a. "需要初审权限" ==> 目标状态:正在初审,当前登录用户无初审权限

a. "需要终审权限" ==> 目标状态:正在终审,当前登录用户无终审权限

a. "此材料正由其他人审核中" ==> 用户试图将其他用户正在初审的材料状态 设置为已初审


状态变化向量

```
switch( $old . "->" . $new ){
    case "未审核->正在初审":
        $this->checkAuditorAdmin0($request);
        $material->set_auditor( $this->user );
        break;
    case "正在审核->正在初审":
        $material->status = "正在初审";
        $material->set_auditor( $this->user );
        break;
    case "正在初审->未审核":
        $material->unset_auditor( $this->user );
        break;
    case "正在初审->已初审":
        if( ! $material->isAuditingBy( $this->user ) ){
            throw new APIError("此材料正由其他人审核中");
        }
        $material->status = $new;
        break;
    case "已初审->正在终审":
        $this->checkAuditorAdmin1( $request );
        $material->status = "正在终审";
        $material->set_auditor( $this->user );
        break;
    default :
        throw new APIError("错误的状态转换路径,材料当前状态为:" . $material->status . " 目标状态为:" . $new );
}
```

Response

```
{
  "errors": [
    "错误的状态转换路径,材料当前状态为:终审通过 目标状态为:正在终审"
  ],
  "debug": [
    []
  ],
  "results": {
    "material": {
      "id": "2495",
      "user_id": "186",
      "title": "20160112 祥康 青岛新闻生活 18.35-19.25 呼吁广大听众为健康快车献计献策.mp3",
      "url": "ftp://xiangkang:zmxiangkang@60.2.126.26/青岛/20160112 祥康 青岛新闻生活 18.35-19.25 呼吁广大听众为健康快车献计献策（新改）.mp3",
      "media_type": "广播",
      "product_title": "祥康",
      "ad_date": "2016-01-12",
      "status": "终审通过",
      "ad_time": "18：35--19:25",
      "ad_duration": "50",
      "ad_version": "",
      "allocated_auditor_id": "0",
      "ad_type": "药品类",
      "ad_product_pihao": "",
      "ad_product_piwen_url": "",
      "ad_product_feature": "",
      "round": "2",
      "history": [
        {
          "round": "1",
          "url": "ftp://xiangkang:zmxiangkang@60.2.126.26/青岛/20160112 祥康 青岛新闻生活 18.35-19.25 呼吁广大听众为健康快车献计献策.mp3",
          "uploaded_at": "2016-01-07 09:06:02"
        }
      ],
      "uploaded_at": "2016-01-07 09:06:02",
      "deleted_at": "",
      "created_at": "2016-01-07 09:06:02",
      "updated_at": "2016-01-12 09:27:29",
      "current_auditor_id": "0",
      "version_id": "0",
      "sample_id": "0",
      "mod_uploaded_at": "-0001-11-30 00:00:00",
      "mod_file": "",
      "timingStatus": "完结",
      "user": {
        "id": "186",
        "email": "",
        "mobile": "13596234851",
        "username": "王丹丹",
        "nickname": "祥康"
      },
      "allocated_auditor": "",
      "channels": [],
      "report_url": "http://auditing1.guanggaobao.com.cn/material/reportx/eyJpdiI6ImFyNEZZdElyVE1ZYTlpamZ2RERKdEE9PSIsInZhbHVlIjoiNmNoS1ZGVENXQ2l5WndNTHgxK1VEUT09IiwibWFjIjoiZjliOTIzNGIxOGI4ZmJlYWViYmY5NGNiOTU3NDlmMDY2OTE4YmRhZGE2Y2I4MThlYWExN2FjODhlMTllZjg1ZSJ9",
      "assigned_channels": "0",
      "auditing_results": [
        {
          "id": "5350",
          "material_id": "2495",
          "auditor_id": "170",
          "results": [
            {
              "监测重点": "广告内容",
              "违规内容": "本片11分04秒，患者叙述：就是我就说说我通过什么方法把我身上的好多病症都调整好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "就是我就说说我通过什么方法让我身上的好多病症都得到了调整。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片11分22秒，患者叙述：通过我的干梳头我慢慢的发现我的白头发少了，而且头发坚固了不脱发了，我有时候洗头发啊一梳头发呀就一层一层的往下掉，现在几乎就掉一两根，我觉得很正常。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "通过我的干梳头我慢慢的发现我的头发有变化了，我有时候洗头发啊一梳头发呀就一层一层的往下掉，现在就有所缓解了，我觉得太高兴了。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片12分04秒，患者叙述：我就用这些慢慢的把身体调理好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "我就用这些慢慢的让身体得到了调理。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片12分17秒，患者叙述：我慢慢的也调整好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "我慢慢的也得到调整了。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片13分11秒，患者叙述：我老公说你今天怎么没说难受啊，我能吃鸡蛋了，就是从此以后我们家有一个习惯每天一个人一个鸡蛋，我就天天吃鸡蛋，我十八年都没吃一个鸡蛋，我觉得鸡蛋太香了，这就是我的胆囊炎调治好了（专家叙述：终于知道鸡蛋是什么味了），对对。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "患者叙述：我老公说你今天怎么不一样了啊，我也觉得自己有变化了，就是我们的这个家庭习惯，我十八年都没吃一个鸡蛋啊（专家叙述：十八年都没能吃一口鸡蛋，都不知道鸡蛋的味道啊），对对。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片14分57秒，专家叙述：从而达到收获健康的目的了（患者叙述：对，就是，我觉得不单自己收获了健康）。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "专家叙述： 从而让自己有所收获了（患者叙述：对，就是，我觉得不单自己有收获了）。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片41分34秒，患者叙述：因为我叔叔吧就是取得这个乌龟尿把耳朵治好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": " 因为我叔叔吧就是取得这个乌龟尿治疗的耳朵。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片41分46秒，患者叙述：就是一个礼拜耳朵就一点点恢复了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "就是一个礼拜耳朵就一点点缓解了。\r\n"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片45分45秒，患者叙述：她说蛮好的，都好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "她说有效果。"
            }
          ],
          "type": "初审",
          "passed": "no",
          "round": "1",
          "deleted_at": "",
          "created_at": "2016-01-07 11:36:21",
          "updated_at": "2016-01-07 11:36:21"
        },
        {
          "id": "5351",
          "material_id": "2495",
          "auditor_id": "168",
          "results": [
            {
              "监测重点": "广告内容",
              "违规内容": "本片11分04秒，患者叙述：就是我就说说我通过什么方法把我身上的好多病症都调整好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "就是我就说说我通过什么方法让我身上的好多病症都得到了调整。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片11分22秒，患者叙述：通过我的干梳头我慢慢的发现我的白头发少了，而且头发坚固了不脱发了，我有时候洗头发啊一梳头发呀就一层一层的往下掉，现在几乎就掉一两根，我觉得很正常。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "通过我的干梳头我慢慢的发现我的头发有变化了，我有时候洗头发啊一梳头发呀就一层一层的往下掉，现在就有所缓解了，我觉得太高兴了。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片12分04秒，患者叙述：我就用这些慢慢的把身体调理好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "我就用这些慢慢的让身体得到了调理。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片12分17秒，患者叙述：我慢慢的也调整好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "我慢慢的也得到调整了。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片13分11秒，患者叙述：我老公说你今天怎么没说难受啊，我能吃鸡蛋了，就是从此以后我们家有一个习惯每天一个人一个鸡蛋，我就天天吃鸡蛋，我十八年都没吃一个鸡蛋，我觉得鸡蛋太香了，这就是我的胆囊炎调治好了（专家叙述：终于知道鸡蛋是什么味了），对对。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "患者叙述：我老公说你今天怎么不一样了啊，我也觉得自己有变化了，就是我们的这个家庭习惯，我十八年都没吃一个鸡蛋啊（专家叙述：十八年都没能吃一口鸡蛋，都不知道鸡蛋的味道啊），对对。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片14分57秒，专家叙述：从而达到收获健康的目的了（患者叙述：对，就是，我觉得不单自己收获了健康）。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "专家叙述： 从而让自己有所收获了（患者叙述：对，就是，我觉得不单自己有收获了）。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片41分34秒，患者叙述：因为我叔叔吧就是取得这个乌龟尿把耳朵治好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": " 因为我叔叔吧就是取得这个乌龟尿治疗的耳朵。"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片41分46秒，患者叙述：就是一个礼拜耳朵就一点点恢复了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "就是一个礼拜耳朵就一点点缓解了。\r\n"
            },
            {
              "监测重点": "广告内容",
              "违规内容": "本片45分45秒，患者叙述：她说蛮好的，都好了。",
              "违法依据": "国家药监总局：药监违规广告监测条令两品一械加其他。\r\n国家工商总局：工商违规广告监测条令。",
              "修改建议": "她说有效果。"
            }
          ],
          "type": "终审",
          "passed": "no",
          "round": "1",
          "deleted_at": "",
          "created_at": "2016-01-07 11:38:41",
          "updated_at": "2016-01-07 11:38:41"
        },
        {
          "id": "5398",
          "material_id": "2495",
          "auditor_id": "170",
          "results": [],
          "type": "初审",
          "passed": "yes",
          "round": "2",
          "deleted_at": "",
          "created_at": "2016-01-07 16:14:02",
          "updated_at": "2016-01-07 16:14:02"
        },
        {
          "id": "5405",
          "material_id": "2495",
          "auditor_id": "168",
          "results": [],
          "type": "终审",
          "passed": "yes",
          "round": "2",
          "deleted_at": "",
          "created_at": "2016-01-07 16:42:34",
          "updated_at": "2016-01-07 16:42:34"
        }
      ],
      "auditors": [
        {
          "id": "170",
          "email": "",
          "mobile": "18730577653",
          "username": "王慧",
          "nickname": "",
          "auditing_round": "2",
          "auditing_result": "通过",
          "auditing_type": "initial",
          "auditing_updated_at": "2016年01月07日 16:14:02"
        },
        {
          "id": "168",
          "email": "",
          "mobile": "18713805939",
          "username": "宋然然",
          "nickname": "",
          "auditing_round": "2",
          "auditing_result": "通过",
          "auditing_type": "final",
          "auditing_updated_at": "2016年01月07日 16:42:34"
        },
        {
          "id": "170",
          "email": "",
          "mobile": "18730577653",
          "username": "王慧",
          "nickname": "",
          "auditing_round": "1",
          "auditing_result": "未通过",
          "auditing_type": "initial",
          "auditing_updated_at": "2016年01月07日 11:36:21"
        },
        {
          "id": "168",
          "email": "",
          "mobile": "18713805939",
          "username": "宋然然",
          "nickname": "",
          "auditing_round": "1",
          "auditing_result": "未通过",
          "auditing_type": "final",
          "auditing_updated_at": "2016年01月07日 11:38:41"
        }
      ]
    }
  },
  "flag": "0"
}
```

```
{
  "errors": [],
  "debug": [],
  "results": {
    "material": {
      ...
    }
  },
  "flag": "1"
}
```