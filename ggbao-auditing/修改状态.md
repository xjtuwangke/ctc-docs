
1. 修改状态

Url

```
http://auditing1.guanggaobao.com.cn/api/client/auditor_material_status_change
```


测试用户

```
u=18019101111
p=18019101111
无任何审核权限的管理员

u=18019101112
p=18019101112
初级审核员

u=18019101114
p=18019101114
另一个初级审核员

u=18019101113
p=18019101113
高级审核员
```

USER STORY

无权限用户试图初审材料

```
{
  "login": "18019101111",
  "password": "18019101111",
  "material_id": 4028,
  "toStatus": "正在初审"
}
```

返回

```
{
  "errors": [
    "需要初审权限"
  ],
...
```

初审用户A登陆

```
{
  "login": "18019101112",
  "password": "18019101112",
  "material_id": 4028,
  "toStatus": "正在初审"
}
```

返回 ** 嘈:PHP代码里边我定义的是flag:1成功,0失败,跟java里是反的... **

```
{
  "errors": [],
  "debug": [],
  ...
  "flag":"1"
}
```

另一个初审用户B试图将其置为已初审

```
{
  "login": "18019101114",
  "password": "18019101114",
  "material_id": 4028,
  "toStatus": "已初审"
}
```

返回错误

```
{
  "errors": [
    "此材料正由其他人审核中"
  ],
  ...
  "flag":"0"
}
```

初审用户A将材料状态改为已初审(略)

终审员C将材料设为正在终审(返回略)

```
{
  "login": "18019101113",
  "password": "18019101113",
  "material_id": 4028,
  "toStatus": "正在终审"
}
```

此时初审用户A无法再提交审核信息

终审通过/不通过需要同一个终审员C 通过 [审核员---上传结果](ggbao-auditing/上传结果.md) API实现



Request

```
{
  "login": "18019101985",
  "password": "pass",
  "material_id":123,
  "toStatus":"xxx",
}
```

几种错误:

a. "错误的状态转换路径,材料当前状态为:xxx 目标状态为:xxx" 

a. "需要初审权限" ==> 目标状态:正在初审,当前登录用户无初审权限

a. "需要终审权限" ==> 目标状态:正在终审,当前登录用户无终审权限

a. "此材料正由其他人审核中" ==> 用户试图将其他用户正在初审的材料状态 设置为已初审


状态变化向量

```
switch( $old . "->" . $new ){
    case "未审核->正在初审":
        $this->checkAuditorAdmin0($request);
        $material->set_auditor( $this->user );
        break;
    case "正在审核->正在初审":
        $material->status = "正在初审";
        $material->set_auditor( $this->user );
        break;
    case "正在初审->未审核":
        $material->unset_auditor( $this->user );
        break;
    case "正在初审->已初审":
        if( ! $material->isAuditingBy( $this->user ) ){
            throw new APIError("此材料正由其他人审核中");
        }
        $material->status = $new;
        break;
    case "已初审->正在终审":
        $this->checkAuditorAdmin1( $request );
        $material->status = "正在终审";
        $material->set_auditor( $this->user );
        break;
    default :
        throw new APIError("错误的状态转换路径,材料当前状态为:" . $material->status . " 目标状态为:" . $new );
}
```

Response

```
{
  "errors": [
    "错误的状态转换路径,材料当前状态为:终审通过 目标状态为:正在终审"
  ],
  "debug": [
    []
  ],
  "results": {
    "material": {
      ...
  },
  "flag": "0"
}
```

```
{
  "errors": [],
  "debug": [],
  "results": {
    "material": {
      ...
    }
  },
  "flag": "1"
}
```